<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>‡∏£‡∏∞‡∏ö‡∏ö‡∏•‡∏á‡πÄ‡∏ß‡∏•‡∏≤‡∏ó‡∏≥‡∏á‡∏≤‡∏ô</title>
    <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Kanit', sans-serif; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); min-height: 100vh; padding: 20px; }
        .container { max-width: 600px; margin: 0 auto; background: white; border-radius: 20px; box-shadow: 0 10px 40px rgba(0,0,0,0.2); overflow: hidden; }
        .header { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 30px 20px; text-align: center; }
        .header h1 { font-size: 24px; margin-bottom: 10px; }
        .user-info { background: rgba(255,255,255,0.2); padding: 15px; border-radius: 10px; margin-top: 15px; text-align: left; font-size: 14px; }
        .user-info p { margin: 5px 0; }
        .content { padding: 30px 20px; }
        .btn-group { display: flex; gap: 15px; margin-bottom: 30px; }
        .btn { flex: 1; padding: 15px; border: none; border-radius: 10px; font-size: 16px; font-weight: bold; cursor: pointer; transition: all 0.3s; }
        .btn-primary { background: #06c755; color: white; }
        .btn-primary:hover { background: #05b04b; transform: translateY(-2px); }
        .btn-secondary { background: #ff6b6b; color: white; }
        .btn-secondary:hover { background: #ee5a52; transform: translateY(-2px); }
        .form-group { margin-bottom: 20px; }
        .form-group label { display: block; margin-bottom: 8px; font-weight: bold; color: #333; }
        .form-group input, .form-group textarea { width: 100%; padding: 12px; border: 2px solid #e0e0e0; border-radius: 8px; font-size: 14px; transition: border 0.3s; }
        .form-group input:focus, .form-group textarea:focus { outline: none; border-color: #667eea; }
        .form-group textarea { min-height: 80px; resize: vertical; }
        .image-upload { display: flex; flex-direction: column; gap: 10px; }
        .image-preview { width: 100%; max-height: 200px; object-fit: cover; border-radius: 8px; margin-top: 10px; display: none; }
        .image-preview.show { display: block; }
        .readonly-data { background: #f5f5f5; padding: 15px; border-radius: 8px; margin-bottom: 20px; }
        .readonly-data p { margin: 8px 0; color: #555; }
        .history-table { width: 100%; overflow-x: auto; margin-top: 30px; }
        table { width: 100%; border-collapse: collapse; min-width: 800px; }
        th, td { padding: 12px; text-align: left; border-bottom: 1px solid #ddd; }
        th { background: #667eea; color: white; font-weight: bold; }
        tr:hover { background: #f5f5f5; }
        .loading { text-align: center; padding: 50px; color: #667eea; }
        .hidden { display: none; }
        .alert { padding: 15px; margin-bottom: 20px; border-radius: 8px; font-weight: bold; }
        .alert-success { background: #d4edda; color: #155724; }
        .alert-error { background: #f8d7da; color: #721c24; }
        @media (max-width: 480px) { .btn-group { flex-direction: column; } }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üöö ‡∏£‡∏∞‡∏ö‡∏ö‡∏•‡∏á‡πÄ‡∏ß‡∏•‡∏≤‡∏ó‡∏≥‡∏á‡∏≤‡∏ô</h1>
            <div class="user-info" id="userInfo" style="display:none;">
                <p><strong>‡∏ä‡∏∑‡πà‡∏≠:</strong> <span id="userName"></span></p>
                <p><strong>‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô‡∏£‡∏ñ:</strong> <span id="userCar"></span></p>
                <p><strong>‡πÄ‡∏ö‡∏≠‡∏£‡πå:</strong> <span id="userPhone"></span></p>
                <p><strong>‡∏™‡∏≤‡∏Ç‡∏≤:</strong> <span id="userBranch"></span></p>
            </div>
        </div>

        <div class="content">
            <div id="loadingScreen" class="loading">
                <p>‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•...</p>
            </div>

            <div id="mainMenu" class="hidden">
                <div class="btn-group">
                    <button class="btn btn-primary" onclick="showStartWorkForm()">üïê ‡∏•‡∏á‡πÄ‡∏ß‡∏•‡∏≤‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏á‡∏≤‡∏ô</button>
                    <button class="btn btn-secondary" onclick="showEndWorkForm()">üïî ‡∏•‡∏á‡πÄ‡∏ß‡∏•‡∏≤‡πÄ‡∏•‡∏¥‡∏Å‡∏á‡∏≤‡∏ô</button>
                </div>
            </div>

            <div id="startWorkForm" class="hidden">
                <h2 style="margin-bottom: 20px;">‡∏•‡∏á‡πÄ‡∏ß‡∏•‡∏≤‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏á‡∏≤‡∏ô</h2>
                <div class="form-group">
                    <label>‚è∞ ‡πÄ‡∏ß‡∏•‡∏≤‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏á‡∏≤‡∏ô</label>
                    <input type="time" id="startTime" required>
                </div>
                <div class="form-group">
                    <label>üõû ‡πÄ‡∏•‡∏Ç‡πÑ‡∏°‡∏•‡πå‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏á‡∏≤‡∏ô</label>
                    <input type="number" id="startMileage" placeholder="‡∏Å‡∏£‡∏≠‡∏Å‡πÄ‡∏•‡∏Ç‡πÑ‡∏°‡∏•‡πå" required>
                </div>
                <div class="form-group">
                    <label>üì∏ ‡∏£‡∏π‡∏õ‡∏ñ‡πà‡∏≤‡∏¢‡πÄ‡∏•‡∏Ç‡πÑ‡∏°‡∏•‡πå‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏á‡∏≤‡∏ô</label>
                    <input type="file" accept="image/*" capture="environment" id="startMileageImage" onchange="previewImage(this, 'startMileagePreview')">
                    <img id="startMileagePreview" class="image-preview">
                </div>
                <div class="form-group">
                    <label>ü§≥ ‡∏£‡∏π‡∏õ‡∏ñ‡πà‡∏≤‡∏¢‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏á‡∏≤‡∏ô</label>
                    <input type="file" accept="image/*" capture="user" id="startEmployeeImage" onchange="previewImage(this, 'startEmployeePreview')">
                    <img id="startEmployeePreview" class="image-preview">
                </div>
                <button class="btn btn-primary" style="width:100%;" onclick="saveStartWork()">üíæ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</button>
            </div>

            <div id="endWorkForm" class="hidden">
                <h2 style="margin-bottom: 20px;">‡∏•‡∏á‡πÄ‡∏ß‡∏•‡∏≤‡πÄ‡∏•‡∏¥‡∏Å‡∏á‡∏≤‡∏ô</h2>
                <div class="readonly-data">
                    <p><strong>‚è∞ ‡πÄ‡∏ß‡∏•‡∏≤‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏á‡∏≤‡∏ô:</strong> <span id="readonlyStartTime"></span></p>
                    <p><strong>üõû ‡πÄ‡∏•‡∏Ç‡πÑ‡∏°‡∏•‡πå‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏á‡∏≤‡∏ô:</strong> <span id="readonlyStartMileage"></span></p>
                </div>
                <div class="form-group">
                    <label>‚è∞ ‡πÄ‡∏ß‡∏•‡∏≤‡πÄ‡∏•‡∏¥‡∏Å‡∏á‡∏≤‡∏ô</label>
                    <input type="time" id="endTime" required>
                </div>
                <div class="form-group">
                    <label>üõû ‡πÄ‡∏•‡∏Ç‡πÑ‡∏°‡∏•‡πå‡πÄ‡∏•‡∏¥‡∏Å‡∏á‡∏≤‡∏ô</label>
                    <input type="number" id="endMileage" placeholder="‡∏Å‡∏£‡∏≠‡∏Å‡πÄ‡∏•‡∏Ç‡πÑ‡∏°‡∏•‡πå" required>
                </div>
                <div class="form-group">
                    <label>üîÑ ‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏£‡∏≠‡∏ö‡∏á‡∏≤‡∏ô‡∏ó‡∏µ‡πà‡∏ß‡∏¥‡πà‡∏á</label>
                    <input type="number" id="rounds" placeholder="‡∏Å‡∏£‡∏≠‡∏Å‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏£‡∏≠‡∏ö" required>
                </div>
                <div class="form-group">
                    <label>üì¶ ‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏à‡∏∏‡∏î‡∏ó‡∏µ‡πà‡∏ô‡∏≥‡∏≠‡∏≠‡∏Å‡∏™‡πà‡∏á‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</label>
                    <input type="number" id="totalPoints" placeholder="‡∏Å‡∏£‡∏≠‡∏Å‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏à‡∏∏‡∏î" required>
                </div>
                <div class="form-group">
                    <label>‚úÖ ‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏à‡∏∏‡∏î‡∏ó‡∏µ‡πà‡∏™‡πà‡∏á‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à</label>
                    <input type="number" id="successPoints" placeholder="‡∏Å‡∏£‡∏≠‡∏Å‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏à‡∏∏‡∏î‡∏ó‡∏µ‡πà‡∏™‡πà‡∏á‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à" required>
                </div>
                <div class="form-group">
                    <label>üìù ‡∏£‡∏∞‡∏ö‡∏∏/‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏</label>
                    <textarea id="note" placeholder="‡∏Å‡∏£‡∏≠‡∏Å‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏ (‡∏ñ‡πâ‡∏≤‡∏°‡∏µ)"></textarea>
                </div>
                <div class="form-group">
                    <label>üì∏ ‡∏£‡∏π‡∏õ‡∏ñ‡πà‡∏≤‡∏¢‡πÄ‡∏•‡∏Ç‡πÑ‡∏°‡∏•‡πå‡πÄ‡∏•‡∏¥‡∏Å‡∏á‡∏≤‡∏ô</label>
                    <input type="file" accept="image/*" capture="environment" id="endMileageImage" onchange="previewImage(this, 'endMileagePreview')">
                    <img id="endMileagePreview" class="image-preview">
                </div>
                <div class="form-group">
                    <label>ü§≥ ‡∏£‡∏π‡∏õ‡∏ñ‡πà‡∏≤‡∏¢‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô‡πÄ‡∏•‡∏¥‡∏Å‡∏á‡∏≤‡∏ô</label>
                    <input type="file" accept="image/*" capture="user" id="endEmployeeImage" onchange="previewImage(this, 'endEmployeePreview')">
                    <img id="endEmployeePreview" class="image-preview">
                </div>
                <button class="btn btn-secondary" style="width:100%;" onclick="saveEndWork()">üíæ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</button>
            </div>

            <div id="summaryView" class="hidden">
                <h2 style="margin-bottom: 20px; color: #06c755;">‚úÖ ‡∏™‡∏£‡∏∏‡∏õ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Å‡∏≤‡∏£‡∏ó‡∏≥‡∏á‡∏≤‡∏ô‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ</h2>
                <div class="readonly-data" id="summaryData"></div>
            </div>

            <div id="historySection" class="hidden">
                <h3 style="margin-top: 30px; margin-bottom: 15px;">üìä ‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡∏ó‡∏≥‡∏á‡∏≤‡∏ô (5 ‡∏ß‡∏±‡∏ô‡∏¢‡πâ‡∏≠‡∏ô‡∏´‡∏•‡∏±‡∏á)</h3>
                <div class="history-table">
                    <table id="historyTable">
                        <thead>
                            <tr>
                                <th>‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà</th>
                                <th>‡πÄ‡∏ß‡∏•‡∏≤‡πÄ‡∏£‡∏¥‡πà‡∏°</th>
                                <th>‡πÄ‡∏ß‡∏•‡∏≤‡πÄ‡∏•‡∏¥‡∏Å</th>
                                <th>‡πÑ‡∏°‡∏•‡πå‡πÄ‡∏£‡∏¥‡πà‡∏°</th>
                                <th>‡πÑ‡∏°‡∏•‡πå‡πÄ‡∏•‡∏¥‡∏Å</th>
                                <th>‡∏£‡∏≠‡∏ö‡∏á‡∏≤‡∏ô</th>
                                <th>‡∏à‡∏∏‡∏î‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</th>
                                <th>‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à</th>
                                <th>‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à</th>
                                <th>‡∏ä‡∏±‡πà‡∏ß‡πÇ‡∏°‡∏á</th>
                                <th>‡∏£‡∏∞‡∏¢‡∏∞‡∏ó‡∏≤‡∏á</th>
                                <th>‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏</th>
                            </tr>
                        </thead>
                        <tbody id="historyBody"></tbody>
                    </table>
                </div>
            </div>

            <div id="registerForm" class="hidden">
                <h2 style="margin-bottom: 20px;">‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô</h2>
                <div class="form-group">
                    <label>‡∏ä‡∏∑‡πà‡∏≠ - ‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏•</label>
                    <input type="text" id="regFullName" required>
                </div>
                <div class="form-group">
                    <label>‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô‡∏£‡∏ñ</label>
                    <input type="text" id="regCarNumber" required>
                </div>
                <div class="form-group">
                    <label>‡πÄ‡∏ö‡∏≠‡∏£‡πå‡∏ï‡∏¥‡∏î‡∏ï‡πà‡∏≠</label>
                    <input type="tel" id="regPhone" required>
                </div>
                <div class="form-group">
                    <label>‡∏™‡∏≤‡∏Ç‡∏≤</label>
                    <input type="text" id="regBranch" required>
                </div>
                <button class="btn btn-primary" style="width:100%;" onclick="registerEmployee()">üíæ ‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô</button>
            </div>
        </div>
    </div>

    <script>
        const CONFIG = {
            LIFF_ID: '2008297366-7ylXdVAB',
            API_URL: 'https://script.google.com/macros/s/AKfycbw2wm3AgQLLRcS5_qo4Xrjg5FNtakRZ4SfzO59cpAx-MVkXP4pD-dVbgFWsuegeIWMi/exec'
        };

        let userProfile = null;
        let employeeData = null;
        let todayRecord = null;

        async function initializeLIFF() {
            try {
                await liff.init({ liffId: CONFIG.LIFF_ID });
                if (!liff.isLoggedIn()) {
                    liff.login();
                    return;
                }
                userProfile = await liff.getProfile();
                await loadEmployeeData();
                await checkTodayStatus();
            } catch (error) {
                console.error('LIFF Error:', error);
                alert('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠ LINE');
            }
        }

        async function loadEmployeeData() {
            const response = await callAPI('getEmployeeData', { userId: userProfile.userId });
            if (!response.success || !response.data) {
                document.getElementById('loadingScreen').classList.add('hidden');
                document.getElementById('registerForm').classList.remove('hidden');
                return;
            }
            employeeData = response.data;
            displayUserInfo();
        }

        function displayUserInfo() {
            document.getElementById('userName').textContent = employeeData.fullName;
            document.getElementById('userCar').textContent = employeeData.carNumber;
            document.getElementById('userPhone').textContent = employeeData.phone;
            document.getElementById('userBranch').textContent = employeeData.branch;
            document.getElementById('userInfo').style.display = 'block';
        }

        async function checkTodayStatus() {
            try {
                const response = await callAPI('checkTodayRecord', { userId: userProfile.userId });
                todayRecord = response.data;
                document.getElementById('loadingScreen').classList.add('hidden');
                if (!todayRecord.hasRecord) {
                    document.getElementById('mainMenu').classList.remove('hidden');
                } else if (todayRecord.startTime && !todayRecord.endTime) {
                    document.getElementById('mainMenu').classList.remove('hidden');
                } else if (todayRecord.endTime) {
                    showSummary();
                    await loadHistory();
                }
            } catch (error) {
                document.getElementById('loadingScreen').textContent = '‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡πÇ‡∏´‡∏•‡∏î‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞';
                console.error('Check status error:', error);
            }
        }

        function showStartWorkForm() {
            if (todayRecord && todayRecord.hasRecord && todayRecord.startTime) {
                alert('‡∏Ñ‡∏∏‡∏ì‡∏•‡∏á‡πÄ‡∏ß‡∏•‡∏≤‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏á‡∏≤‡∏ô‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ‡πÅ‡∏•‡πâ‡∏ß');
                return;
            }
            document.getElementById('mainMenu').classList.add('hidden');
            document.getElementById('startWorkForm').classList.remove('hidden');
            const now = new Date();
            document.getElementById('startTime').value = `${String(now.getHours()).padStart(2,'0')}:${String(now.getMinutes()).padStart(2,'0')}`;
        }

        function showEndWorkForm() {
            if (!todayRecord || !todayRecord.hasRecord || !todayRecord.startTime) {
                alert('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏•‡∏á‡πÄ‡∏ß‡∏•‡∏≤‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏á‡∏≤‡∏ô‡∏Å‡πà‡∏≠‡∏ô');
                return;
            }
            if (todayRecord.endTime) {
                alert('‡∏Ñ‡∏∏‡∏ì‡∏•‡∏á‡πÄ‡∏ß‡∏•‡∏≤‡πÄ‡∏•‡∏¥‡∏Å‡∏á‡∏≤‡∏ô‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ‡πÅ‡∏•‡πâ‡∏ß');
                return;
            }
            document.getElementById('mainMenu').classList.add('hidden');
            document.getElementById('endWorkForm').classList.remove('hidden');
            document.getElementById('readonlyStartTime').textContent = todayRecord.startTime;
            document.getElementById('readonlyStartMileage').textContent = todayRecord.startMileage;
            const now = new Date();
            document.getElementById('endTime').value = `${String(now.getHours()).padStart(2,'0')}:${String(now.getMinutes()).padStart(2,'0')}`;
        }

        async function saveStartWork() {
            const loading = document.createElement('div');
            loading.className = 'loading';
            loading.textContent = '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å...';
            document.getElementById('startWorkForm').appendChild(loading);
            const startTime = document.getElementById('startTime').value;
            const startMileage = document.getElementById('startMileage').value;
            const startMileageImage = document.getElementById('startMileageImage').files[0];
            const startEmployeeImage = document.getElementById('startEmployeeImage').files[0];
            if (!startTime || !startMileage || !startMileageImage || !startEmployeeImage) {
                alert('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏ö‡∏ñ‡πâ‡∏ß‡∏ô');
                document.getElementById('startWorkForm').removeChild(loading);
                return;
            }
            if (isNaN(startMileage) || startMileage <= 0) {
                alert('‡πÄ‡∏•‡∏Ç‡πÑ‡∏°‡∏•‡πå‡∏ï‡πâ‡∏≠‡∏á‡πÄ‡∏õ‡πá‡∏ô‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏Ç‡∏ö‡∏ß‡∏Å');
                document.getElementById('startWorkForm').removeChild(loading);
                return;
            }
            try {
                const mileageImageUrl = await uploadImage(startMileageImage, 'start_mileage');
                const employeeImageUrl = await uploadImage(startEmployeeImage, 'start_employee');
                const response = await callAPI('saveStartWork', {
                    userId: userProfile.userId,
                    startTime,
                    startMileage,
                    startMileageImageUrl: mileageImageUrl,
                    startEmployeeImageUrl: employeeImageUrl
                });
                if (response.success) {
                    const alertDiv = document.createElement('div');
                    alertDiv.className = 'alert alert-success';
                    alertDiv.textContent = '‚úÖ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÄ‡∏ß‡∏•‡∏≤‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏á‡∏≤‡∏ô‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢';
                    document.getElementById('startWorkForm').appendChild(alertDiv);
                    setTimeout(() => {
                        alertDiv.remove();
                        document.getElementById('startWorkForm').classList.add('hidden');
                        document.getElementById('mainMenu').classList.remove('hidden');
                        checkTodayStatus();
                    }, 3000);
                }
            } catch (error) {
                const alertDiv = document.createElement('div');
                alertDiv.className = 'alert alert-error';
                alertDiv.textContent = '‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: ' + error.message;
                document.getElementById('startWorkForm').appendChild(alertDiv);
                setTimeout(() => alertDiv.remove(), 3000);
            }
            document.getElementById('startWorkForm').removeChild(loading);
        }

        async function saveEndWork() {
            const loading = document.createElement('div');
            loading.className = 'loading';
            loading.textContent = '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å...';
            document.getElementById('endWorkForm').appendChild(loading);
            const endTime = document.getElementById('endTime').value;
            const endMileage = document.getElementById('endMileage').value;
            const rounds = document.getElementById('rounds').value;
            const totalPoints = document.getElementById('totalPoints').value;
            const successPoints = document.getElementById('successPoints').value;
            const note = document.getElementById('note').value;
            const endMileageImage = document.getElementById('endMileageImage').files[0];
            const endEmployeeImage = document.getElementById('endEmployeeImage').files[0];
            if (!endTime || !endMileage || !rounds || !totalPoints || !successPoints || !endMileageImage || !endEmployeeImage) {
                alert('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏ö‡∏ñ‡πâ‡∏ß‡∏ô');
                document.getElementById('endWorkForm').removeChild(loading);
                return;
            }
            if (isNaN(endMileage) || endMileage <= 0 || parseFloat(endMileage) < parseFloat(todayRecord.startMileage)) {
                alert('‡πÄ‡∏•‡∏Ç‡πÑ‡∏°‡∏•‡πå‡πÄ‡∏•‡∏¥‡∏Å‡∏á‡∏≤‡∏ô‡∏ï‡πâ‡∏≠‡∏á‡∏°‡∏≤‡∏Å‡∏Å‡∏ß‡πà‡∏≤‡πÄ‡∏•‡∏Ç‡πÑ‡∏°‡∏•‡πå‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏á‡∏≤‡∏ô‡πÅ‡∏•‡∏∞‡πÄ‡∏õ‡πá‡∏ô‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏Ç‡∏ö‡∏ß‡∏Å');
                document.getElementById('endWorkForm').removeChild(loading);
                return;
            }
            if (parseInt(successPoints) > parseInt(totalPoints)) {
                alert('‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏à‡∏∏‡∏î‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à‡∏ï‡πâ‡∏≠‡∏á‡πÑ‡∏°‡πà‡πÄ‡∏Å‡∏¥‡∏ô‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏à‡∏∏‡∏î‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î');
                document.getElementById('endWorkForm').removeChild(loading);
                return;
            }
            try {
                const mileageImageUrl = await uploadImage(endMileageImage, 'end_mileage');
                const employeeImageUrl = await uploadImage(endEmployeeImage, 'end_employee');
                const response = await callAPI('saveEndWork', {
                    userId: userProfile.userId,
                    endTime,
                    endMileage,
                    rounds,
                    totalPoints,
                    successPoints,
                    note,
                    endMileageImageUrl: mileageImageUrl,
                    endEmployeeImageUrl: employeeImageUrl
                });
                if (response.success) {
                    const alertDiv = document.createElement('div');
                    alertDiv.className = 'alert alert-success';
                    alertDiv.textContent = '‚úÖ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÄ‡∏ß‡∏•‡∏≤‡πÄ‡∏•‡∏¥‡∏Å‡∏á‡∏≤‡∏ô‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢';
                    document.getElementById('endWorkForm').appendChild(alertDiv);
                    setTimeout(() => {
                        alertDiv.remove();
                        document.getElementById('endWorkForm').classList.add('hidden');
                        document.getElementById('mainMenu').classList.remove('hidden');
                        checkTodayStatus();
                    }, 3000);
                }
            } catch (error) {
                const alertDiv = document.createElement('div');
                alertDiv.className = 'alert alert-error';
                alertDiv.textContent = '‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: ' + error.message;
                document.getElementById('endWorkForm').appendChild(alertDiv);
                setTimeout(() => alertDiv.remove(), 3000);
            }
            document.getElementById('endWorkForm').removeChild(loading);
        }

        async function registerEmployee() {
            const fullName = document.getElementById('regFullName').value;
            const carNumber = document.getElementById('regCarNumber').value;
            const phone = document.getElementById('regPhone').value;
            const branch = document.getElementById('regBranch').value;
            if (!fullName || !carNumber || !phone || !branch) {
                alert('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏ö‡∏ñ‡πâ‡∏ß‡∏ô');
                return;
            }
            if (!/^\d{10}$/.test(phone)) {
                alert('‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£‡∏ï‡πâ‡∏≠‡∏á‡πÄ‡∏õ‡πá‡∏ô‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏Ç 10 ‡∏´‡∏•‡∏±‡∏Å');
                return;
            }
            try {
                const response = await callAPI('registerEmployee', {
                    userId: userProfile.userId,
                    fullName,
                    carNumber,
                    phone,
                    branch
                });
                if (response.success) {
                    const alertDiv = document.createElement('div');
                    alertDiv.className = 'alert alert-success';
                    alertDiv.textContent = '‚úÖ ‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à';
                    document.getElementById('registerForm').appendChild(alertDiv);
                    setTimeout(() => {
                        alertDiv.remove();
                        document.getElementById('registerForm').classList.add('hidden');
                        loadEmployeeData();
                    }, 3000);
                }
            } catch (error) {
                const alertDiv = document.createElement('div');
                alertDiv.className = 'alert alert-error';
                alertDiv.textContent = '‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: ' + error.message;
                document.getElementById('registerForm').appendChild(alertDiv);
                setTimeout(() => alertDiv.remove(), 3000);
            }
        }

        function showSummary() {
            document.getElementById('summaryView').classList.remove('hidden');
            const summaryHTML = `
                <p><strong>‚è∞ ‡πÄ‡∏ß‡∏•‡∏≤‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏á‡∏≤‡∏ô:</strong> ${todayRecord.startTime}</p>
                <p><strong>üõû ‡πÄ‡∏•‡∏Ç‡πÑ‡∏°‡∏•‡πå‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏á‡∏≤‡∏ô:</strong> ${todayRecord.startMileage}</p>
                <p><strong>‚è∞ ‡πÄ‡∏ß‡∏•‡∏≤‡πÄ‡∏•‡∏¥‡∏Å‡∏á‡∏≤‡∏ô:</strong> ${todayRecord.endTime}</p>
                <p><strong>üõû ‡πÄ‡∏•‡∏Ç‡πÑ‡∏°‡∏•‡πå‡πÄ‡∏•‡∏¥‡∏Å‡∏á‡∏≤‡∏ô:</strong> ${todayRecord.endMileage}</p>
                <p><strong>üîÑ ‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏£‡∏≠‡∏ö‡∏á‡∏≤‡∏ô:</strong> ${todayRecord.rounds}</p>
                <p><strong>üì¶ ‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏à‡∏∏‡∏î‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î:</strong> ${todayRecord.totalPoints}</p>
                <p><strong>‚úÖ ‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏à‡∏∏‡∏î‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à:</strong> ${todayRecord.successPoints}</p>
                <p><strong>‚ùå ‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏à‡∏∏‡∏î‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à:</strong> ${todayRecord.totalPoints - todayRecord.successPoints}</p>
                <p><strong>‚è±Ô∏è ‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏ä‡∏±‡πà‡∏ß‡πÇ‡∏°‡∏á‡∏ó‡∏≥‡∏á‡∏≤‡∏ô:</strong> ${todayRecord.workHours} ‡∏ä‡∏°.</p>
                <p><strong>üõ£Ô∏è ‡∏£‡∏∞‡∏¢‡∏∞‡∏ó‡∏≤‡∏á‡∏£‡∏ß‡∏°:</strong> ${todayRecord.totalDistance} ‡∏Å‡∏°.</p>
                <p><strong>üìù ‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏:</strong> ${todayRecord.note || '-'}</p>
            `;
            document.getElementById('summaryData').innerHTML = summaryHTML;
        }

        async function loadHistory() {
            const response = await callAPI('getWorkHistory', { userId: userProfile.userId });
            if (response.success && response.data.length > 0) {
                document.getElementById('historySection').classList.remove('hidden');
                const tbody = document.getElementById('historyBody');
                tbody.innerHTML = '';
                response.data.forEach(record => {
                    const row = tbody.insertRow();
                    row.innerHTML = `
                        <td>${record.date}</td>
                        <td>${record.startTime}</td>
                        <td>${record.endTime}</td>
                        <td>${record.startMileage}</td>
                        <td>${record.endMileage}</td>
                        <td>${record.rounds}</td>
                        <td>${record.totalPoints}</td>
                        <td>${record.successPoints}</td>
                        <td>${record.failedPoints}</td>
                        <td>${record.workHours}</td>
                        <td>${record.totalDistance}</td>
                        <td>${record.note || '-'}</td>
                    `;
                });
            }
        }

        async function uploadImage(file, type) {
            return new Promise((resolve, reject) => {
                if (file.size > 1024 * 1024) {
                    reject(new Error('‡πÑ‡∏ü‡∏•‡πå‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û‡∏ï‡πâ‡∏≠‡∏á‡πÑ‡∏°‡πà‡πÄ‡∏Å‡∏¥‡∏ô 1MB'));
                    return;
                }
                const reader = new FileReader();
                reader.onload = async function(e) {
                    try {
                        const response = await callAPI('uploadImage', {
                            base64Image: e.target.result,
                            mimeType: file.type,
                            fileName: `${type}_${userProfile.userId}_${Date.now()}.jpg`
                        });
                        if (response.success) {
                            resolve(response.data.url);
                        } else {
                            reject(new Error('‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à'));
                        }
                    } catch (error) {
                        reject(error);
                    }
                };
                reader.readAsDataURL(file);
            });
        }

        function previewImage(input, previewId) {
            if (input.files && input.files[0]) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    const preview = document.getElementById(previewId);
                    preview.src = e.target.result;
                    preview.classList.add('show');
                };
                reader.readAsDataURL(input.files[0]);
            }
        }

        async function callAPI(action, data) {
            try {
                const response = await fetch(CONFIG.API_URL, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    mode: 'cors',
                    body: JSON.stringify({ action, data })
                });
                if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
                const result = await response.json();
                if (!result.success) throw new Error(result.error || 'API error');
                return result;
            } catch (error) {
                console.error('API call failed:', error);
                throw error;
            }
        }

        window.onload = initializeLIFF;
    </script>

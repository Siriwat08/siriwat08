<!doctype html>
<html lang="th">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>‡∏•‡∏á‡πÄ‡∏ß‡∏•‡∏≤‡πÄ‡∏•‡∏¥‡∏Å‡∏á‡∏≤‡∏ô / ‡∏™‡∏£‡∏∏‡∏õ</title>
<link href="https://fonts.googleapis.com/css2?family=Kanit:wght@400;600&display=swap" rel="stylesheet">
<style>
body{font-family:Kanit, sans-serif;margin:0;padding:18px;background:#f0f2f5}
.container{max-width:980px;margin:20px auto;background:white;padding:22px;border-radius:12px;box-shadow:0 8px 24px rgba(0,0,0,0.06)}
.readonly{background:#f7fafc;padding:12px;border-radius:10px;margin-bottom:12px}
label{display:block;margin-top:10px;font-weight:600}
input,textarea{width:100%;padding:10px;margin-top:6px;border:1px solid #ddd;border-radius:8px}
.btn{margin-top:14px;padding:12px;background:#f5a623;color:white;border:0;border-radius:10px;cursor:pointer;font-weight:700}
.small{font-size:0.9rem;color:#666}
.table-wrap{overflow-x:auto;margin-top:18px}
table{width:100%;border-collapse:collapse;min-width:1200px}
th,td{padding:10px;border-bottom:1px solid #eee;text-align:center}
th{background:linear-gradient(135deg,#FF6B35,#D84315);color:white;position:sticky;top:0}
.status-complete{background:#48bb78;color:white;padding:4px 8px;border-radius:6px}
.status-incomplete{background:#ed8936;color:white;padding:4px 8px;border-radius:6px}
</style>
</head>
<body>
<div class="container">
  <h2>‡∏•‡∏á‡πÄ‡∏ß‡∏•‡∏≤‡πÄ‡∏•‡∏¥‡∏Å‡∏á‡∏≤‡∏ô / ‡∏™‡∏£‡∏∏‡∏õ‡∏Å‡∏≤‡∏£‡∏ó‡∏≥‡∏á‡∏≤‡∏ô</h2>
  <div id="empBrief" class="small">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î...</div>

  <div class="readonly">
    <div>‡πÄ‡∏ß‡∏•‡∏≤‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏á‡∏≤‡∏ô: <span id="startTime">-</span></div>
    <div>‡πÄ‡∏•‡∏Ç‡πÑ‡∏°‡∏•‡πå‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏á‡∏≤‡∏ô: <span id="startMileage">-</span></div>
  </div>

  <label>‡πÄ‡∏ß‡∏•‡∏≤‡πÄ‡∏•‡∏¥‡∏Å‡∏á‡∏≤‡∏ô<input type="time" id="endTime"></label>
  <label>‡πÄ‡∏•‡∏Ç‡πÑ‡∏°‡∏•‡πå‡πÄ‡∏•‡∏¥‡∏Å‡∏á‡∏≤‡∏ô<input type="number" id="endMileage" step="0.1"></label>
  <label>‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏£‡∏≠‡∏ö‡∏á‡∏≤‡∏ô‡∏ó‡∏µ‡πà‡∏ß‡∏¥‡πà‡∏á<input type="number" id="trips"></label>
  <label>‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏à‡∏∏‡∏î‡∏ô‡∏≥‡∏≠‡∏≠‡∏Å‡∏™‡πà‡∏á‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î<input type="number" id="totalDeliveries"></label>
  <label>‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏à‡∏∏‡∏î‡∏ó‡∏µ‡πà‡∏™‡πà‡∏á‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à<input type="number" id="successfulDeliveries"></label>
  <label>‡∏£‡∏∞‡∏ö‡∏∏/‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏<textarea id="notes"></textarea></label>

  <div style="margin-top:10px">
    <input type="file" id="endMileagePhoto" accept="image/*" capture="environment" style="display:none">
    <button class="btn" id="pickMile">üì∏ ‡∏ñ‡πà‡∏≤‡∏¢/‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏£‡∏π‡∏õ‡πÄ‡∏•‡∏Ç‡πÑ‡∏°‡∏•‡πå</button>
    <input type="file" id="endEmployeePhoto" accept="image/*" capture="user" style="display:none">
    <button class="btn" id="pickEmp" style="background:#06C755;margin-left:8px">ü§≥ ‡∏ñ‡πà‡∏≤‡∏¢/‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏£‡∏π‡∏õ‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô</button>
  </div>

  <div style="margin-top:12px">
    <button id="saveBtn" class="btn" style="background:#06C755">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏•‡∏¥‡∏Å‡∏á‡∏≤‡∏ô</button>
  </div>

  <div id="message" class="small" style="margin-top:12px;color:#333"></div>

  <div class="table-wrap" id="historyWrap" style="display:none">
    <h3>‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥ 5 ‡∏ß‡∏±‡∏ô‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î</h3>
    <table id="histTable">
      <thead><tr>
        <th>‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà</th><th>‡πÄ‡∏ß‡∏•‡∏≤‡πÄ‡∏£‡∏¥‡πà‡∏°</th><th>‡πÑ‡∏°‡∏•‡πå‡πÄ‡∏£‡∏¥‡πà‡∏°</th><th>‡πÄ‡∏ß‡∏•‡∏≤‡πÄ‡∏•‡∏¥‡∏Å</th><th>‡πÑ‡∏°‡∏•‡πå‡πÄ‡∏•‡∏¥‡∏Å</th><th>‡∏ä‡∏±‡πà‡∏ß‡πÇ‡∏°‡∏á</th><th>‡∏£‡∏∞‡∏¢‡∏∞‡∏ó‡∏≤‡∏á</th><th>‡∏£‡∏≠‡∏ö</th><th>‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</th><th>‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à</th><th>‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à</th><th>‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏</th><th>‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞</th>
      </tr></thead>
      <tbody id="histBody"></tbody>
    </table>
  </div>
</div>

<script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
<script>
const LIFF_ID = '2008305167-2jq75jZE';
const GAS_WEB_APP_URL = 'https://script.google.com/macros/s/AKfycbzWMoKsrv8wJYS-axOyhBHM8eEpKP-gEKr4Kx6HAjwDuDeLNb3qREWeNhOJJCac_-IH/exec';

function serverCall(action,args){
  return fetch(GAS_WEB_APP_URL,{method:'POST',headers:{'Content-Type':'application/json'},mode:'cors',body: JSON.stringify({action, args})})
  .then(r=>r.json()).then(j=>{ if(j.status==='error') throw new Error(j.message||'server error'); return j.response; });
}
function readFileAsBase64(file){
  return new Promise(resolve=>{
    if(!file){ resolve(null); return; }
    const r = new FileReader();
    r.onload = e => resolve(e.target.result);
    r.onerror = ()=> resolve(null);
    r.readAsDataURL(file);
  });
}
function calcFailed(total, success){ return Number(total||0) - Number(success||0); }

(async function(){
  try {
    await liff.init({ liffId: LIFF_ID });
    if(!liff.isLoggedIn()){ liff.login(); return; }
    const profile = await liff.getProfile();
    const state = await serverCall('getWorkStateForToday', [profile.userId]);
    if(state.status==='NO_EMP'){ alert('‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô'); window.location.href='./register.html'; return; }
    const emp = state.employeeData;
    document.getElementById('empBrief').textContent = `${'{'}emp['‡∏ä‡∏∑‡πà‡∏≠ - ‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏•']||profile.displayName{'}'} ‚Ä¢ ${'{'}emp['‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô‡∏£‡∏ñ']||''{'}'}`;
    if(state.status==='NOT_STARTED'){ alert('‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡∏•‡∏á‡πÄ‡∏ß‡∏•‡∏≤‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏á‡∏≤‡∏ô'); window.location.href='./start.html'; return; }

    const w = state.workData;
    // fill readonly
    document.getElementById('startTime').textContent = w['‡πÄ‡∏ß‡∏•‡∏≤‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏á‡∏≤‡∏ô'] || '-';
    document.getElementById('startTime').textContent = w['‡πÄ‡∏ß‡∏•‡∏≤‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏á‡∏≤‡∏ô'] || '-';
    document.getElementById('startMileage').textContent = w['‡πÄ‡∏•‡∏Ç‡πÑ‡∏°‡∏•‡πå‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏á‡∏≤‡∏ô'] || '-';

    // if already completed -> show summary only
    if(state.status === 'COMPLETED'){
      document.getElementById('endTime').value = w['‡πÄ‡∏ß‡∏•‡∏≤‡πÄ‡∏•‡∏¥‡∏Å‡∏á‡∏≤‡∏ô'] || '';
      document.getElementById('endMileage').value = w['‡πÄ‡∏•‡∏Ç‡πÑ‡∏°‡∏•‡πå‡πÄ‡∏•‡∏¥‡∏Å‡∏á‡∏≤‡∏ô'] || '';
      document.getElementById('trips').value = w['‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏£‡∏≠‡∏ö‡∏á‡∏≤‡∏ô‡∏ó‡∏µ‡πà‡∏ß‡∏¥‡πà‡∏á'] || '';
      document.getElementById('totalDeliveries').value = w['‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏à‡∏∏‡∏î‡∏ó‡∏µ‡πà‡∏ô‡∏≥‡∏≠‡∏≠‡∏Å‡∏™‡πà‡∏á‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î'] || '';
      document.getElementById('successfulDeliveries').value = w['‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏à‡∏∏‡∏î‡∏ó‡∏µ‡πà‡∏™‡πà‡∏á‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à'] || '';
      document.getElementById('notes').value = w['‡∏£‡∏∞‡∏ö‡∏∏/‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏'] || '';
      document.getElementById('message').textContent = '‡∏™‡∏£‡∏∏‡∏õ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ (‡∏≠‡πà‡∏≤‡∏ô‡∏≠‡∏¢‡πà‡∏≤‡∏á‡πÄ‡∏î‡∏µ‡∏¢‡∏ß)';
    }

    // photo pickers
    document.getElementById('pickMile').addEventListener('click', ()=> document.getElementById('endMileagePhoto').click());
    document.getElementById('pickEmp').addEventListener('click', ()=> document.getElementById('endEmployeePhoto').click());

    document.getElementById('saveBtn').addEventListener('click', async ()=>{
      const endTime = document.getElementById('endTime').value;
      const endMileage = document.getElementById('endMileage').value;
      const trips = document.getElementById('trips').value;
      const totalDeliveries = document.getElementById('totalDeliveries').value;
      const successfulDeliveries = document.getElementById('successfulDeliveries').value;
      const notes = document.getElementById('notes').value;
      if(!endTime||!endMileage||!trips||!totalDeliveries||!successfulDeliveries){ alert('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏ö'); return; }
      if(Number(endMileage) <= Number(w['‡πÄ‡∏•‡∏Ç‡πÑ‡∏°‡∏•‡πå‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏á‡∏≤‡∏ô']||0)){ alert('‡πÄ‡∏•‡∏Ç‡πÑ‡∏°‡∏•‡πå‡πÄ‡∏•‡∏¥‡∏Å‡∏á‡∏≤‡∏ô‡∏ï‡πâ‡∏≠‡∏á‡∏°‡∏≤‡∏Å‡∏Å‡∏ß‡πà‡∏≤‡πÄ‡∏•‡∏Ç‡πÑ‡∏°‡∏•‡πå‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏á‡∏≤‡∏ô'); return; }
      const endMileagePhoto = await readFileAsBase64(document.getElementById('endMileagePhoto').files[0]);
      const endEmployeePhoto = await readFileAsBase64(document.getElementById('endEmployeePhoto').files[0]);
      const payload = {
        userId: profile.userId,
        endTime, endMileage, trips, totalDeliveries, successfulDeliveries, notes, endMileagePhoto, endEmployeePhoto
      };
      const res = await serverCall('saveEndWork', [payload]);
      if(res.status && res.status==='error'){ alert(res.message||'‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î'); return; }
      alert(res.message || '‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢');
      if(liff.isInClient()) liff.closeWindow(); else window.location.reload();
    });

    // history
    const hist = await serverCall('getWorkHistory', [profile.userId]);
    if(hist && hist.length){
      document.getElementById('historyWrap').style.display='block';
      const body = document.getElementById('histBody');
      body.innerHTML = '';
      hist.forEach(r=>{
        const tr = document.createElement('tr');
        const failed = Number(r['‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏à‡∏∏‡∏î‡∏ó‡∏µ‡πà‡∏™‡πà‡∏á‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à']||0);
        const status = (r['‡πÄ‡∏ß‡∏•‡∏≤‡πÄ‡∏•‡∏¥‡∏Å‡∏á‡∏≤‡∏ô'] && r['‡πÄ‡∏ß‡∏•‡∏≤‡πÄ‡∏•‡∏¥‡∏Å‡∏á‡∏≤‡∏ô']!=='') ? '<span class="status-complete">‡∏™‡∏°‡∏ö‡∏π‡∏£‡∏ì‡πå</span>' : '<span class="status-incomplete">‡πÑ‡∏°‡πà‡∏™‡∏°‡∏ö‡∏π‡∏£‡∏ì‡πå</span>';
        const cells = [
          r['‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏á‡∏≤‡∏ô‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà']||'-', r['‡πÄ‡∏ß‡∏•‡∏≤‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏á‡∏≤‡∏ô']||'-', r['‡πÄ‡∏•‡∏Ç‡πÑ‡∏°‡∏•‡πå‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏á‡∏≤‡∏ô']||'-', r['‡πÄ‡∏ß‡∏•‡∏≤‡πÄ‡∏•‡∏¥‡∏Å‡∏á‡∏≤‡∏ô']||'-', r['‡πÄ‡∏•‡∏Ç‡πÑ‡∏°‡∏•‡πå‡πÄ‡∏•‡∏¥‡∏Å‡∏á‡∏≤‡∏ô']||'-',
          r['‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏ä‡∏±‡πà‡∏ß‡πÇ‡∏°‡∏á‡∏Å‡∏≤‡∏£‡∏ó‡∏≥‡∏á‡∏≤‡∏ô']||'-', r['‡∏£‡∏∞‡∏¢‡∏∞‡∏ó‡∏≤‡∏á‡∏£‡∏ß‡∏°']||'-', r['‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏£‡∏≠‡∏ö‡∏á‡∏≤‡∏ô‡∏ó‡∏µ‡πà‡∏ß‡∏¥‡πà‡∏á']||'-', r['‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏à‡∏∏‡∏î‡∏ó‡∏µ‡πà‡∏ô‡∏≥‡∏≠‡∏≠‡∏Å‡∏™‡πà‡∏á‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î']||'-',
          r['‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏à‡∏∏‡∏î‡∏ó‡∏µ‡πà‡∏™‡πà‡∏á‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à']||'-', r['‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏à‡∏∏‡∏î‡∏ó‡∏µ‡πà‡∏™‡πà‡∏á‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à']||'-', r['‡∏£‡∏∞‡∏ö‡∏∏/‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏']||'-', status
        ];
        tr.innerHTML = cells.map(c=>`<td>${c}</td>`).join('');
        body.appendChild(tr);
      });
    }

  } catch(e){
    alert('Error: '+e.message); console.error(e);
  }
})();
</script>
</body>
</html>

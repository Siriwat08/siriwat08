<!doctype html>
<html lang="th">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>ลงทะเบียนพนักงาน</title>
<link href="https://fonts.googleapis.com/css2?family=Kanit:wght@400;600&display=swap" rel="stylesheet">
<style>
body{font-family:Kanit, sans-serif;margin:0;padding:20px;background:#f0f2f5}
.container{max-width:640px;margin:24px auto;background:white;padding:18px;border-radius:12px;box-shadow:0 6px 18px rgba(0,0,0,0.06)}
label{display:block;margin-top:10px;font-weight:600}
input{width:100%;padding:10px;margin-top:6px;border:1px solid #ddd;border-radius:8px}
.btn{margin-top:14px;padding:12px;background:#06C755;color:white;border:0;border-radius:10px;cursor:pointer;font-weight:700}
.small{font-size:0.9rem;color:#666}
</style>
</head>
<body>
<div class="container">
  <h2>ลงทะเบียนพนักงาน</h2>
  <div id="info" class="small">กำลังเชื่อมกับ LINE...</div>
  <form id="frm">
    <label>ชื่อ - นามสกุล<input id="name" required></label>
    <label>ทะเบียนรถ<input id="plate" required></label>
    <label>เบอร์ติดต่อ<input id="phone" required></label>
    <label>สาขา<input id="branch" required></label>
    <button class="btn" type="submit">ลงทะเบียน</button>
  </form>
</div>

<script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
<script>
const LIFF_ID = '2008305167-2jq75jZE';
const GAS_WEB_APP_URL = 'https://script.google.com/macros/s/AKfycbzWMoKsrv8wJYS-axOyhBHM8eEpKP-gEKr4Kx6HAjwDuDeLNb3qREWeNhOJJCac_-IH/exec'; 

function serverCall(action,args){
  return fetch(GAS_WEB_APP_URL,{method:'POST',headers:{'Content-Type':'application/json'},mode:'cors',body: JSON.stringify({action, args})})
  .then(r=>r.json()).then(j=>{ if(j.status==='error') throw new Error(j.message||'server error'); return j.response; });
}
(async function(){
  try{
    await liff.init({ liffId: LIFF_ID });
    if(!liff.isLoggedIn()){ liff.login(); return; }
    const profile = await liff.getProfile();
    document.getElementById('info').textContent = `ลงทะเบียนสำหรับ: ${profile.displayName}`;
    document.getElementById('frm').addEventListener('submit', async (e)=>{
      e.preventDefault();
      const data = {
        userId: profile.userId,
        'ชื่อ - นามสกุล': document.getElementById('name').value.trim(),
        'ทะเบียนรถ': document.getElementById('plate').value.trim(),
        'เบอร์ติดต่อ': document.getElementById('phone').value.trim(),
        'สาขา': document.getElementById('branch').value.trim()
      };
      // client validation
      for(const k of ['ชื่อ - นามสกุล','ทะเบียนรถ','เบอร์ติดต่อ','สาขา']){
        if(!data[k]){ alert('กรุณากรอกข้อมูลให้ครบ'); return; }
      }
      const res = await serverCall('registerEmployee', [data]);
      alert(res.message || 'ลงทะเบียนเรียบร้อย');
      // go to start page
      if(liff.isInClient()) liff.closeWindow();
      else window.location.href = './start.html';
    });
  }catch(e){ alert('Error: '+e.message); console.error(e); }
})();
</script>
</body>
</html>
